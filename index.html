<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>La Web</title>

  <link rel="icon" type="image/png" href="./favicon.png?v=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Comic Sans MS", cursive;
      background: radial-gradient(circle at top, #ffe0f0 0, #fcefee 40%, #fff 100%);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      padding: 10px 0 0;
      font-size: 2.4rem;
      letter-spacing: 2px;
      color: #ff5c7a;
      text-shadow: 3px 3px 0 #fff, -1px -1px 0 #ffd1e1;
    }

    .subtitle {
      text-align: center;
      font-size: 0.95rem;
      margin-bottom: 8px;
      color: #666;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: row;
      border-top: 4px dashed #ffd1e1;
    }

    .panel {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      position: relative;
    }

    .panel-simi {
      background: linear-gradient(135deg, #ffe9f0, #fff5d9);
      border-right: 3px solid #ffb6c1;
    }

    .panel-modeun {
      background: linear-gradient(135deg, #d9f3ff, #e9e9ff);
      border-left: 3px solid #99c2ff;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .panel-header img.avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(255,255,255,0.95);
      box-shadow: 0 0 8px rgba(0,0,0,0.25);
      background: #fff;
    }

    .panel-title {
      font-size: 1.6rem;
      text-shadow: 1px 1px 0 #fff;
    }

    .panel-header small {
      display: block;
      font-size: 0.8rem;
      color: #555;
    }

    .counter-box {
      background: rgba(255,255,255,0.9);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .counter-label { font-weight: bold; font-size: 1rem; }

    .counter-value {
      font-size: 1.6rem;
      font-weight: bold;
      color: #ff4081;
      min-width: 50px;
      text-align: center;
    }

    .counter-buttons button {
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      margin-left: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .btn-plus {
      background: #7ed957;
      color: #fff;
      box-shadow: 0 2px 0 #4e9c35;
    }

    .btn-minus {
      background: #ff9f68;
      color: #fff;
      box-shadow: 0 2px 0 #c96c35;
    }

    .counter-buttons button:hover {
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 3px 0 rgba(0,0,0,0.2);
    }

    .store {
      background: rgba(255,255,255,0.9);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
    }

    .store-title {
      font-size: 1.15rem;
      margin-bottom: 6px;
    }

    .item-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .store-item {
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,0.05);
      padding: 8px;
      background: #fff8fc;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition: transform 0.12s, box-shadow 0.12s, background 0.12s;
      font-size: 0.9rem;
    }

    .store-item strong { font-size: 1rem; }

    /* precios dorados */
    .store-item .cost {
      color: #ffbf00;
      font-weight: bold;
      text-shadow: 0 0 3px #fff3b0;
    }

    .store-item:hover:not(.locked) {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      background: #ffe9f7;
    }

    .store-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .history {
      background: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
      max-height: 220px;
      overflow-y: auto;
    }

    .history-title {
      font-size: 1.05rem;
      margin-bottom: 4px;
    }

    .history-list {
      list-style: none;
      font-size: 0.85rem;
    }

    .history-list li {
      padding: 3px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
    }

    .history-empty {
      font-size: 0.8rem;
      color: #777;
    }

    .history-controls {
      text-align: right;
      margin-bottom: 4px;
    }

    .btn-clear {
      border: none;
      border-radius: 8px;
      padding: 3px 8px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #ddd;
      color: #333;
      transition: background 0.15s;
    }

    .btn-clear:hover { background: #bbb; }

    @media (max-width: 800px) {
      .container { flex-direction: column; }
      .panel-simi {
        border-right: none;
        border-bottom: 3px solid #ffb6c1;
      }
      .panel-modeun {
        border-left: none;
        border-top: 3px solid #99c2ff;
      }
    }
  </style>
</head>
<body>
  <h1>La Web</h1>
  <p class="subtitle">Chiquipoints de Simi y Modeun</p>

  <div class="container">
    <!-- Panel Simi -->
    <section class="panel panel-simi">
      <div class="panel-header">
        <img class="avatar" src="clarence.jpg" alt="Clarence / Simi" />
        <div>
          <div class="panel-title">Simi Â· Mundo Clarence</div>
          <small>Haz clic en la tienda para canjear Chiquipoints</small>
        </div>
      </div>

      <div class="counter-box">
        <div class="counter-label">Chiquipoints de Simi:</div>
        <div class="counter-value" id="simi-counter">0</div>
        <div class="counter-buttons">
          <button class="btn-plus" onclick="changePoints('simi', 1)">+1</button>
          <button class="btn-minus" onclick="changePoints('simi', -1)">âˆ’1</button>
        </div>
      </div>

      <div class="store">
        <div class="store-title">Tienda de Simi</div>
        <div class="item-list">
          <button class="store-item"
                  data-player="simi"
                  data-cost="8"
                  data-name="GGST 30 min">
            <span><strong>GGST 30 min</strong></span>
            <span class="cost">8 Chiquipoints</span>
          </button>

          <button class="store-item"
                  data-player="simi"
                  data-cost="10"
                  data-name="Splatoon 3 30 min">
            <span><strong>Splatoon 3 30 min</strong></span>
            <span class="cost">10 Chiquipoints</span>
          </button>

          <button class="store-item"
                  data-player="simi"
                  data-cost="10"
                  data-name="Enter the Gungeon 30 min">
            <span><strong>Enter the Gungeon 30 min</strong></span>
            <span class="cost">10 Chiquipoints</span>
          </button>

          <!-- Bloqueados -->
          <button class="store-item locked"
                  data-player="simi"
                  data-cost="14"
                  data-name="Brawlhalla 30 min"
                  data-locked="true"
                  data-required-spent="7">
            <span><strong>ðŸ”’ Brawlhalla 30 min</strong></span>
            <span class="cost">14 Chiquipoints (se desbloquea tras gastar 7)</span>
          </button>

          <button class="store-item locked"
                  data-player="simi"
                  data-cost="50"
                  data-name="Calistenia 40 min"
                  data-locked="true"
                  data-required-spent="25">
            <span><strong>ðŸ”’ Calistenia 40 min</strong></span>
            <span class="cost">50 Chiquipoints (se desbloquea tras gastar 25)</span>
          </button>

          <button class="store-item locked"
                  data-player="simi"
                  data-cost="30"
                  data-name="Paseo con sol 20 min"
                  data-locked="true"
                  data-required-spent="15">
            <span><strong>ðŸ”’ Paseo con sol 20 min</strong></span>
            <span class="cost">30 Chiquipoints (se desbloquea tras gastar 15)</span>
          </button>

          <button class="store-item locked"
                  data-player="simi"
                  data-cost="500"
                  data-name="7 sesiones de gym nuevas"
                  data-locked="true"
                  data-required-spent="250">
            <span><strong>ðŸ”’ 7 sesiones de gym nuevas (1h y media)</strong></span>
            <span class="cost">500 Chiquipoints (se desbloquea tras gastar 250)</span>
          </button>
        </div>
      </div>

      <div class="history">
        <div class="history-controls">
          <button class="btn-clear" onclick="clearHistory('simi')">Borrar historial</button>
        </div>
        <div class="history-title">Historial de Simi</div>
        <ul class="history-list" id="simi-history"></ul>
        <div class="history-empty" id="simi-history-empty">TodavÃ­a no hay compras.</div>
      </div>
    </section>

    <!-- Panel Modeun -->
    <section class="panel panel-modeun">
      <div class="panel-header">
        <img class="avatar" src="gumball.jpg" alt="Gumball / Modeun" />
        <div>
          <div class="panel-title">Modeun Â· Mundo Gumball</div>
          <small>Haz clic en la tienda para canjear Chiquipoints</small>
        </div>
      </div>

      <div class="counter-box">
        <div class="counter-label">Chiquipoints de Modeun:</div>
        <div class="counter-value" id="modeun-counter">0</div>
        <div class="counter-buttons">
          <button class="btn-plus" onclick="changePoints('modeun', 1)">+1</button>
          <button class="btn-minus" onclick="changePoints('modeun', -1)">âˆ’1</button>
        </div>
      </div>

      <div class="store">
        <div class="store-title">Tienda de Modeun</div>
        <div class="item-list">
          <button class="store-item"
                  data-player="modeun"
                  data-cost="10"
                  data-name="Minecraft Dungeons 30 min">
            <span><strong>Minecraft Dungeons 30 min</strong></span>
            <span class="cost">10 Chiquipoints</span>
          </button>

          <button class="store-item"
                  data-player="modeun"
                  data-cost="12"
                  data-name="Monster Hunter 30 min">
            <span><strong>Monster Hunter 30 min</strong></span>
            <span class="cost">12 Chiquipoints</span>
          </button>

          <button class="store-item"
                  data-player="modeun"
                  data-cost="16"
                  data-name="Juego de cartas 30 min">
            <span><strong>Juego de cartas 30 min</strong></span>
            <span class="cost">16 Chiquipoints</span>
          </button>

          <!-- Bloqueados -->
          <button class="store-item locked"
                  data-player="modeun"
                  data-cost="30"
                  data-name="PokÃ©mon 1 hora"
                  data-locked="true"
                  data-required-spent="15">
            <span><strong>ðŸ”’ PokÃ©mon 1 hora</strong></span>
            <span class="cost">30 Chiquipoints (se desbloquea tras gastar 15)</span>
          </button>

          <button class="store-item locked"
                  data-player="modeun"
                  data-cost="45"
                  data-name="Anime nuevo 3h"
                  data-locked="true"
                  data-required-spent="22">
            <span><strong>ðŸ”’ Anime nuevo 3h</strong></span>
            <span class="cost">45 Chiquipoints (se desbloquea tras gastar 22)</span>
          </button>

          <button class="store-item locked"
                  data-player="modeun"
                  data-cost="60"
                  data-name="Juego nuevo 3h (modo historia)"
                  data-locked="true"
                  data-required-spent="25">
            <span><strong>ðŸ”’ Juego nuevo 3h (modo historia)</strong></span>
            <span class="cost">50 Chiquipoints (se desbloquea tras gastar 25)</span>
          </button>

          <button class="store-item locked"
                  data-player="modeun"
                  data-cost="500"
                  data-name="Nuevo rango TFT"
                  data-locked="true"
                  data-required-spent="250">
            <span><strong>ðŸ”’ Nuevo rango TFT (30 horas aprox)</strong></span>
            <span class="cost">500 Chiquipoints (se desbloquea tras gastar 250)</span>
          </button>
        </div>
      </div>

      <div class="history">
        <div class="history-controls">
          <button class="btn-clear" onclick="clearHistory('modeun')">Borrar historial</button>
        </div>
        <div class="history-title">Historial de Modeun</div>
        <ul class="history-list" id="modeun-history"></ul>
        <div class="history-empty" id="modeun-history-empty">TodavÃ­a no hay compras.</div>
      </div>
    </section>
  </div>

  <!-- Firebase + lÃ³gica en tiempo real -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUe4fZVAZipiuqFAPQCJ0FqOIrZJFE908",
      authDomain: "la-web-d9f4e.firebaseapp.com",
      databaseURL: "https://la-web-d9f4e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "la-web-d9f4e",
      storageBucket: "la-web-d9f4e.firebasestorage.app",
      messagingSenderId: "133048092874",
      appId: "1:133048092874:web:b611c14e29651f23e44c33",
      measurementId: "G-7FSVPK5QMP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    onValue(ref(db, "simi/points"), (snap) => {
      const val = snap.exists() ? snap.val() : 0;
      document.getElementById("simi-counter").textContent = val;
    });

    onValue(ref(db, "modeun/points"), (snap) => {
      const val = snap.exists() ? snap.val() : 0;
      document.getElementById("modeun-counter").textContent = val;
    });

    onValue(ref(db, "simi/history"), (snap) => {
      const list = snap.exists() ? snap.val() : [];
      renderHistory("simi", list);
    });

    onValue(ref(db, "modeun/history"), (snap) => {
      const list = snap.exists() ? snap.val() : [];
      renderHistory("modeun", list);
    });

    function renderHistory(player, history) {
      const listId = player === "simi" ? "simi-history" : "modeun-history";
      const emptyId = player === "simi" ? "simi-history-empty" : "modeun-history-empty";
      const ul = document.getElementById(listId);
      const empty = document.getElementById(emptyId);

      ul.innerHTML = "";
      if (!history || history.length === 0) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      history.forEach((entry) => {
        const li = document.createElement("li");
        li.textContent = `${entry.fecha} Â· ${entry.nombre} (-${entry.coste} puntos)`;
        ul.appendChild(li);
      });
    }

    function formatDate() {
      const now = new Date();
      const dia = String(now.getDate()).padStart(2, "0");
      const mes = String(now.getMonth() + 1).padStart(2, "0");
      const anio = now.getFullYear();
      const hora = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${anio} ${hora}:${min}`;
    }

    async function getCurrentPoints(player) {
      const snap = await get(child(ref(db), player + "/points"));
      return snap.exists() ? snap.val() : 0;
    }

    async function getCurrentHistory(player) {
      const snap = await get(child(ref(db), player + "/history"));
      return snap.exists() ? snap.val() : [];
    }

    async function getTotalSpent(player) {
      const snap = await get(child(ref(db), player + "/totalSpent"));
      return snap.exists() ? snap.val() : 0;
    }

    async function setTotalSpent(player, value) {
      await set(ref(db, player + "/totalSpent"), value);
    }

    function checkLockedItems(player, totalSpent) {
      const items = document.querySelectorAll(
        `.store-item[data-player="${player}"][data-locked="true"]`
      );
      items.forEach(btn => {
        const required = parseInt(btn.getAttribute("data-required-spent"), 10) || 0;
        if (totalSpent >= required) {
          btn.classList.remove("locked");
          btn.disabled = false;
        } else {
          btn.classList.add("locked");
          btn.disabled = true;
        }
      });
    }

    window.changePoints = async function(player, delta) {
      let current = await getCurrentPoints(player);
      current += delta;
      if (current < 0) current = 0;
      await set(ref(db, player + "/points"), current);
    };

    window.clearHistory = async function(player) {
      if (!confirm("Â¿Seguro que quieres borrar el historial de " + player + "?")) return;
      await set(ref(db, player + "/history"), []);
      await setTotalSpent(player, 0);
      checkLockedItems(player, 0);
    };

    async function handlePurchaseInternal(player, cost, name) {
      let current = await getCurrentPoints(player);
      cost = parseInt(cost, 10);

      if (current < cost) {
        alert("No hay suficientes Chiquipoints para comprar \"" + name + "\".");
        return;
      }

      let totalSpent = await getTotalSpent(player);
      current -= cost;
      totalSpent += cost;

      await set(ref(db, player + "/points"), current);
      await setTotalSpent(player, totalSpent);

      const history = await getCurrentHistory(player);
      history.unshift({
        fecha: formatDate(),
        nombre: name,
        coste: cost
      });
      await set(ref(db, player + "/history"), history);

      checkLockedItems(player, totalSpent);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const items = document.querySelectorAll(".store-item");
      items.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (btn.disabled || btn.classList.contains("locked")) return;
          const player = btn.getAttribute("data-player");
          const cost = btn.getAttribute("data-cost");
          const name = btn.getAttribute("data-name");
          handlePurchaseInternal(player, cost, name);
        });
      });

      const simiSpent = await getTotalSpent("simi");
      const modeunSpent = await getTotalSpent("modeun");
      checkLockedItems("simi", simiSpent);
      checkLockedItems("modeun", modeunSpent);
    });
  </script>
</body>
</html>
